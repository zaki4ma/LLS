# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

回答は日本語で行ってください。モチベーションを維持できる回答をしてください。

ファイルは機能単位で適度なファイルサイズで分けて実装してください。

## Project Overview

「ルミナス・ロスト・シグナル」は、エイリアンに襲われた巨大宇宙船の中を探索し、エイリアンと戦いながら生き残るローグライクゲームです。Web技術（HTML5、CSS3、JavaScript ES6+、Web Audio API）を使用して実装されています。

## Running the Game

```bash
# ローカル開発サーバーを起動
python -m http.server 8000
# または
python3 -m http.server 8000

# ブラウザで http://localhost:8000 にアクセス
```

## Core Architecture

### Module Structure
ゲームは以下の主要なモジュールに分割されています：

- **GameCore.js**: メインゲームループ、イベントハンドラー、全体統括、チートシステム
- **PlayerManager.js**: プレイヤー状態管理、能力システム、戦闘処理、無敵モード
- **EnemyManager.js**: 敵AI、行動パターン、スポーンシステム
- **LevelGenerator.js**: プロシージャルマップ生成、部屋配置、エンジンルーム生成
- **ItemManager.js**: アイテム生成、収集システム、バランス調整
- **RenderManager.js**: 描画処理、視界システム、エフェクト管理
- **UIManager.js**: ユーザーインターフェース、モーダル、戦闘ログ、エンディング表示
- **UpgradeManager.js**: アップグレードメニュー、特殊能力購入
- **QualitativeUpgradeManager.js**: 質的アップグレードシステム（チェインストライク、反撃、自動修復）
- **RangedWeaponManager.js**: 遠距離武器システム、プラズマ砲、レーザー砲、ミサイル
- **CommunicationManager.js**: 通信システム、ストーリー進行、イベント管理
- **DodgeSystem.js**: 回避システム、連続回避ボーナス
- **BGMManager.js**: Howler.js BGM管理、フェード機能、音量制御
- **audio.js**: Tone.js効果音システム、BGM管理、効果音
- **constants.js**: ゲーム定数、敵タイプ、能力定義、エンジンルーム設定
- **ranking.js**: ランキングシステム、ローカルストレージ管理

### Game State Management
ゲーム状態は`GameCore.js`のRoguelikeGameクラスで一元管理されています。重要な状態変数：

- `grid`: 20x20のゲームマップ
- `visibleCells`: プレイヤーの視界システム
- `exploredCells`: 探索済みエリアの記録
- `floor`: 現在のデッキ階層（1-20、20階が最終マップ）
- `gameOver`: ゲームオーバー状態
- `inUpgradeMenu`: アップグレードメニュー表示状態

### Audio System
デュアル音響システムでBGMと効果音を管理：

**BGMManager.js（Howler.js）**:
- **6段階BGM**: beginning.mp3, danger_area.mp3, tension.mp3, engine_room.mp3, ending_gameover.mp3
- **自動フェード**: デッキ進行に応じてスムーズな音楽切り替え
- **音量制御**: +/-キーによるリアルタイム音量調整

**SoundManager（Tone.js）**:
- **効果音**: 攻撃、アイテム収集、特殊能力、クリティカル音など
- **音響効果**: レベルアップ、回避、シールド、テレポート音
- **個別音量**: BGMとSFXの独立した音量制御

### Combat System
戦闘システムの重要な特徴：

- **ターン制**: プレイヤーの行動後に敵が行動
- **クリティカル攻撃**: 15%の確率で2倍ダメージ（レベルアップで30%まで向上）
- **シールドシステム**: 一回限りの攻撃無効化
- **酸素システム**: 毎ターン消費、不足時はダメージ

### Level Progression
レベル設計は段階的な難易度上昇：

- **デッキ1-5**: 基本的な探索、beginning.mp3
- **デッキ6-10**: 難易度上昇、danger_area.mp3、新しい敵タイプ
- **デッキ11-14**: 危険区域、tension.mp3、より強力な敵
- **デッキ15-19**: 最大危険区域、高い緊迫感
- **デッキ20**: エンジンルーム、engine_room.mp3、最終選択

## Game Constants

### Enemy Types
`constants.js`で定義された敵タイプ：

- **BASIC**: 基本的な追跡敵（デッキ1+）
- **STALKER**: 徘徊型敵（デッキ3+）
- **CHARGER**: 突進型敵（デッキ6+）
- **GUARDIAN**: 守護型敵（デッキ6+）
- **HUNTER**: 巡回型敵（デッキ9+）
- **SCOUT**: 召喚型敵（デッキ9+）

### Special Abilities
特殊能力は3つのカテゴリーに分類：

- **基本能力**: テレポート、シールド（デッキ1+）
- **中級能力**: エナジーブラスト、ハッキング（デッキ3+）
- **上級能力**: 酸素リサイクラー、オートメディック（デッキ6+）

## Code Style and Patterns

### Component Communication
全てのコンポーネントは`gameInstance`パラメータを通じて通信します。直接的な相互参照は避け、GameCoreが仲介役を果たします。

### State Management
プレイヤー状態、敵状態、アイテム状態は各々のManagerクラスで管理されており、GameCoreが統括します。

### Event Handling
キーボードイベントは`GameCore.js`で一元管理され、ゲーム状態に応じて適切なManagerに委譲されます。

### Error Handling
音響システムでは`try-catch`を使用した包括的なエラーハンドリングを実装しています。

## Game Balance

### Resource Management
- **HP**: 基本100、レベルアップで+10
- **酸素**: 基本100、毎ターン消費（階層に応じて増加）
- **Gold**: 特殊能力購入に使用

### Item Spawn Rates
- **武器コンテナ**: 75%の確率で出現（デッキ3+では追加40%）
- **医療コンテナ**: 70%の確率で出現
- **酸素コンテナ**: 常に2個配置

### Combat Balance
- **基本攻撃力**: 20（レベルアップで+2）
- **基本防御力**: 5（レベルアップで+1）
- **クリティカル率**: 15%（レベルアップで最大30%）

## Visual System

### Lighting System
`RenderManager.js`で実装された方向性照明：

- **向いている方向**: 通常の照明範囲（4マス）
- **背後方向**: 制限された照明範囲（2マス）
- **プレイヤーの向き**: 移動方向に応じて自動更新

### Rendering Pipeline
1. グリッドの初期化
2. 視界計算
3. セルの描画
4. エフェクトの表示
5. UIの更新

## Performance Considerations

### Memory Management
- ゲームオブジェクトの適切な初期化とクリーンアップ
- イベントリスナーの適切な削除
- 大量のDOM操作の回避

### Audio Performance
- 音響リソースの事前初期化
- 効果音の適切な停止とリソース解放
- 音量調整の効率的な実装

## 世界観
深宇宙探査船ルミナス号
君は保守技術者として、3年間の任務を終え地球への帰路についていた。
乗員120名、帰還予定まで残り3日...

「緊急事態発生。全員、持ち場を離れ避難せよ」
最後の船内放送から6時間が経過した。

機械室での定期点検中に気を失い、今ようやく目覚めた。
薄暗い非常灯だけが照らす廊下に、人の姿はない。
静寂を破るのは、どこからか聞こえる奇怪な鳴き声だけ。

スーツの表示：酸素残量3時間、電力わずか
無線：応答なし

3年ぶりに待つ故郷へ帰るため、
仲間たちの身に何が起こったのかを知るため...
一人きりの探索が始まる。

## 目的・エンディング
デッキ20にあるエンジンルームを目指し、最終的な選択を行う：

### エンディング選択
**修理エンディング**: エンジンを修理して地球帰還（エイリアンも同行）
**爆破エンディング**: 爆破装置で自己犠牲、地球を守る（+50,000点ボーナス）

### スコアシステム
- 基本スコア: フロア×1000 + 撃破×100 + ゴールド×10 + HP×50
- クリア完了ボーナス: +25,000点
- 英雄エンディングボーナス: +50,000点

## 実装済み機能（2024年12月完成版）

### 完全なエンディングシステム
- **エンジンルーム生成**: デッキ20に6x6のエンジンルーム配置
- **エンジンコア**: 中央に配置された最終目標（⚙シンボル）
- **2択エンディング**: 修理（地球帰還）vs 爆破（自己犠牲）
- **詳細なストーリー**: 各エンディング専用の物語とメッセージ
- **スコアシステム**: エンディング別ボーナス、ランキング登録

### 質的アップグレードシステム
- **チェインストライク**: 連続攻撃でダメージボーナス、範囲攻撃
- **カウンターアタック**: 被攻撃時の自動反撃システム
- **オートリペア**: 戦闘外での自動HP回復
- **3段階進化**: 各能力がレベル3まで成長
- **相乗効果**: 複数能力の組み合わせボーナス

### 完全BGMシステム（Howler.js + Suno AI）
- **6曲構成**: beginning, danger_area, tension, engine_room, ending_gameover
- **自動切り替え**: デッキ進行に応じた動的BGM変更
- **フェード機能**: スムーズな楽曲間トランジション
- **音量制御**: リアルタイム音量調整（+/-キー）

### 遠距離武器システム
- **3種類の武器**: プラズマ砲、レーザー砲、ミサイル
- **キーバインド**: 1-3キーで武器選択、Rキーでターゲットモード
- **マウス対応**: クリックによる標的指定システム
- **射程表示**: 攻撃範囲の視覚的フィードバック

### 回避・防御システム
- **回避システム**: 敵・プレイヤー双方の回避判定
- **連続回避**: 回避成功時のボーナス蓄積
- **シールドシステム**: 一回限りの攻撃無効化
- **視覚フィードバック**: DODGE/MISSエフェクト

### 通信・ストーリーシステム
- **ストーリー進行**: フロア進行に応じた自動イベント
- **通信ログ**: 受信したメッセージの履歴管理
- **全フロア照明**: 特定条件での全マップ可視化機能

### デバッグ・チートシステム
- **Cキー**: チートモード切り替え（赤枠表示）
- **Fキー**: デッキ20直接移動（エンジンルーム）
- **Gキー**: 無敵モード（体力・酸素無限、ダメージ無効）
- **Kキー**: 敵全滅（経験値・ゴールド獲得あり）

### 技術実装詳細

#### 視界システム（RenderManager.js）
```javascript
// 3段階の視界状態
if (isVisible) {
    cell.classList.add('lit');           // 100% opacity
} else if (isExplored) {
    cell.classList.add('explored');      // 60% opacity, 40% brightness
} else {
    cell.classList.add('dark');          // 15% opacity, 20% brightness
}
```

#### 方向性照明システム
- **前方照明**: 4マス範囲での通常視界
- **後方照明**: 2マス範囲での制限視界
- **動的更新**: 移動方向に応じた照明方向の自動調整

#### 描画パイプライン
1. 視界計算 (`calculateVisibility()`)
2. セル描画 (`render()`)
3. エフェクト表示 (`showFloatingText()`)
4. UI更新 (`updateStatus()`)

### システム統合
- **GameCore.js**: 全システムの統括と初期化
- **CommunicationManager.js**: イベントシステムとの連携
- **RenderManager.js**: 視界・描画システムの統合

### デバッグ・開発支援
- **段階的ログ**: 初期化からレンダリングまでの詳細ログ
- **エラーハンドリング**: 音声システムなど非必須機能の安全な初期化
- **動的デバッグ**: コンソールでの状態確認機能

### パフォーマンス最適化
- **効率的な視界計算**: 線形走査とブレゼンハムアルゴリズム
- **DOM操作の最小化**: 一括更新による描画最適化
- **メモリ管理**: 適切なオブジェクトライフサイクル管理